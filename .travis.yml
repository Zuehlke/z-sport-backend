language: java
services:
  - docker
env:
  global:
  - PATH=$PATH:$HOME/google-cloud-sdk/bin
  - PROJECT_ID="z-sport-frontend-test"
  - ZONE="europe-west1-b"
  - IMAGE_NAME=z-sport-backend:latest
  - GOOGLE_APPLICATION_CREDENTIALS="client-secret.json"
  - CLUSTER_NAME=z-sport-backend-cluster
  - FULL_IMAGE_NAME=gcr.io/devops-workshops-for-schools/$IMAGE_NAME
jdk:
  - oraclejdk11
before_cache:
  - rm -f  $HOME/.gradle/caches/modules-2/modules-2.lock
  - rm -fr $HOME/.gradle/caches/*/plugin-resolution/
cache:
  directories:
  - $HOME/.gradle/caches/
  - $HOME/.gradle/wrapper/
  - $HOME/google-cloud-sdk/
before_install:
  - ls -la
  - openssl aes-256-cbc -K $encrypted_21af30358e49_key -iv $encrypted_21af30358e49_iv -in client-secret.json.enc -out client-secret.json -d
install:
  - ./gradlew build
before_script:
  - gcloud version || true
  - if [ ! -d "$HOME/google-cloud-sdk/bin" ]; then rm -rf $HOME/google-cloud-sdk; export CLOUDSDK_CORE_DISABLE_PROMPTS=1; curl https://sdk.cloud.google.com | bash; fi
  - source /home/travis/google-cloud-sdk/path.bash.inc
  - gcloud components update
  - gcloud components install kubectl
jobs:
  include:
    #- stage: "Unit Tests"
    #  script:
    #    - ./gradlew test
    - stage: "Deploy to GCP"
      script:
        - docker images
        - docker build -t $FULL_IMAGE_NAME .
        - docker images
        - gcloud auth activate-service-account travis-kubernetes-service-acc@devops-workshops-for-schools.iam.gserviceaccount.com --key-file=client-secret.json
        - gcloud docker -- push $FULL_IMAGE_NAME
        - gcloud container clusters get-credentials z-sport-backend-cluster --zone europe-west1-c --project devops-workshops-for-schools
        - kubectl --help
        #- kubectl run your-containername --image=gcr.io/${PROJECT_ID}/your-image:latest --port 8080
        #- kubectl expose deployment your-containername --type=LoadBalancer --port 80 --target-port 8080


